#cloud-config
install:
    device: /dev/sda
    auto: true
    poweroff: true
hostname: minis-{{ trunc 4 .MachineID }}
users:
    - name: kairos
      ssh_authorized_keys:
        - github:HasseJohansen
k3s:
    enabled: true
    args:
        - --disable=traefik,servicelb
kubevip:
    eip: 192.168.8.8
p2p:
    # Disabling DHT makes co-ordination to discover nodes only in the local network
    #Enabled by default
    disable_dht: true
    vpn:
        # defaults to true
        create: false
        # defaults to true
        use: false
    # network_token is the shared secret used by the nodes to co-ordinate with p2p.
    # Setting a network token implies auto.enable = true.
    # To disable, just set auto.enable = false
    network_token: ENC[AES256_GCM,data:BzC6+flRZMaqQPHz7tHmkfOWa2pqQ/SrCqgWfvs3ZT5cnoKSKVN5RBlVSni+88dQ4AUpWfeRcu9gurQRK2AIZ/3M7e8Ux1Rhkaa9ta2U/sD17KWVllEksM0bkCX+5WVCJVr2HeioG15URoYRIoqcw9M0X4QM9Pvd3kEtqbe5sGJkFZJuDi+HonVtTGIezxVW1lEE1gVGVk7PpzcdEg9hJCoCyIwYDraVD5sy208Y3DT59q03VDyxdOIlOwC9Wko85Dsa4QF19D2Aa5V+F+OTn2cLvamsHjHR0+/4fnlGuSDxFaRvkg6AJI4kEp0Ue4l+twAWDfXF/qo1AjCNQhZ4lSc2wmrlkVHrrQN+mrwRIpV2oqoflGFQ7CSvUj1P+nRfG+GWaV1BiEJskqXBnhAeOwUeO+ol0OcXFm5Jro+ZEJj8GenEVN+uhKUMYVmFFG12EZasVrDjgOoWaVLQfJS+CaeSo8t08rm8DbJQvaXtw93wqNFjT5RBUflETHk9KS3e1t3k5jdSOWaSGRfN0u7ZFbtsxYt5Y986PMBssrjSLFRVRcUzWlP19VBhBK1B/czaPcw3KxZHg9MtaXLbeYNsXpsvFsGA5SSRjMt76dflAnqBfFJ4+1uee97qgwkFtPOnm++LAGiE2nWPBe5kD7Nyn5RYCHnFOVoLbMBzIg==,iv:3Hz0GZAPYejU6RvAPMEx7H1hd16AHIe7wc8XkXsPiLs=,tag:plJKhUY2wTxuwCG0fL0fRA==,type:str]
    # Automatic cluster deployment configuration
    auto:
        # Enables Automatic node configuration (self-coordination)
        # for role assignment
        enable: true
        # HA enables automatic HA roles assignment.
        # A master cluster init is always required,
        # Any additional master_node is configured as part of the
        # HA control plane.
        # If auto is disabled, HA has no effect.
        ha:
            # Enables HA control-plane
            enable: true
            # Number of HA additional master nodes.
            # A master node is always required for creating the cluster and is implied.
            # The setting below adds 2 additional master nodes, for a total of 3.
            master_nodes: 1
bundles:
    - targets:
        - run://hassejohansen/flux:latest
flux:
    env:
        GITHUB_TOKEN: ENC[AES256_GCM,data:Drf1gUtp3fUatm+EbzNfkjsLCb7kv8/sldVzu4GxAS8X6AnznKABRQ==,iv:ZBBs6HZ6sgmsrgeSNyJ8WaEbCY5WRKFGMusYTsxt4eQ=,tag:V2l7NzJpPZ9qQUoVktrmQQ==,type:str]
    github:
        owner: HasseJohansen
        repository: fleet-infra
        path: clusters/minis
        components-extra: image-reflector-controller,image-automation-controller
        network-policy: "false"
stages:
    after-install-chroot:
        - files:
            - path: /etc/systemd/network/10-dhcp.network
              owner: 0
              group: 0
              permissions: 420
              content: |
                [Match]
                Name=enp47s0
                [Link]
                Unmanaged=yes
          commands:
            - rm -f /var/lib/dbus/machine-id
            - rm -f /etc/machine-id
            - dbus-uuidgen --ensure
            - systemd-machine-id-setup
            - sed -i '/^config_url:.*$/d' /oem/90_custom.yaml
        - name: Create data dir
          commands:
            - mkdir -p /data
        - name: Format /dev/nvme0n1
          commands:
            - mkfs.ext4 -F /dev/nvme0n1
    # Creates the data dir after reset inside the final system chroot, just in case it's not there
    after-reset-chroot:
        - !!merge <<:
            name: Create data dir
            commands:
                - mkdir -p /data
    # Creates the data dir after upgrade inside the final system chroot, just in case it's not there
    after-upgrade-chroot:
        - !!merge <<:
            name: Create data dir
            commands:
                - mkdir -p /data
    initramfs:
        # Mounts the disk under the /data dir during initramfs on each boot, with RW. Extra options can be added to the mount here
        - name: Mount /dev/nvme0n1 under /data
          commands:
            - mount -o rw /dev/nvme0n1 /data
    boot:
        - name: Add flux-system namespace manifest
          files:
            - path: /var/lib/rancher/k3s/server/manifests/flux-system.yaml
              content: |
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: flux-system
        - name: Download SOPS secret
          files:
            - path: /var/lib/rancher/k3s/server/manifests/sops-secret.yaml
              content: |
                apiVersion: v1
                data:
                  age.agekey: <AGE key>
                kind: Secret
                type: Opaque
                metadata:
                  name: sops-age
                  namespace: flux-system
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1k4pr9evth7r8f6dajz6jee945582dklr72mklj9gpwcvnxkgc5asruclml
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBUVG5Ic2I0My9QNXA5WDhR
            eUNBUUlyK0Jtc3cyamFrV2pGTk42U3FRcDI4ClVvK1o4c2lYVGFtVU4rY0hPbUh1
            M2RPTGN5aTdFcFkyQVdNeTUxOHBmamMKLS0tIEh4MnVKbzNkZGZpOVNlNzc4ZlJS
            SzMxQUxvL050R2ZhVVN2TEhpQXpDTUUKDCClEjJCUk8QhsRONeTc9fkl3S6pwGc7
            XfhozaTPZV6IFFao/A5xVGaVST0v36I8t4rEYvgbnEHba8g2Y1+YTQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-02-25T13:50:44Z"
    mac: ENC[AES256_GCM,data:MUoH7gjthwnnVYLs23pUln9fFruJw5Oo+G2tTZXhAe2qbbXqWRjIgdW7k6KHyA72wgfIkTxEVpLICzNQNgCu/9LyJVYCl3wt98C5FIAby3PLLoOFXXosJZRpQHwrCj2kNSd29klnKA88a6qZbY6dyzkvOUHWg/W/YVv4fedopz0=,iv:dtdsznoHk2MMtByagbrn/SHm4SVKhQlgdLo0elEuVSg=,tag:06D0+2STdVSZzRXiJKG39Q==,type:str]
    pgp: []
    encrypted_regex: ^(GITHUB_TOKEN|network_token)$
    version: 3.8.1
